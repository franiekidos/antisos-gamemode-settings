#!/bin/bash
#
# antisOS Gamemode Launcher
#
# This script reads the configuration generated by 'antisOS Gamemode options'
# from /etc/environment and launches a command (e.g., a game) inside Gamescope
# with those settings.
#
# It includes a dynamic check to apply necessary NVIDIA-specific environment
# variables only when the proprietary driver is detected, ensuring compatibility
# across AMD/Intel (Mesa) and NVIDIA machines.
#
# Usage:
#   gamemode-run.sh [game_executable] [game_arguments...]
#

# --- Safety Checks ---

# Ensure a command to run is provided
if [ "$#" -eq 0 ]; then
    echo "Usage: $0 <command-to-run>"
    echo "Example: $0 supertuxkart"
    exit 1
fi

# Check if gamescope is installed
if ! command -v gamescope &> /dev/null; then
    echo "Warning: 'gamescope' command not found. Running command without Gamescope."
    exec "$@"
fi

# --- Load Configuration ---

# Source the environment file if it exists
if [ -f /etc/environment ]; then
    # Use 'set -a' to export all variables defined in the file
    set -a
    source /etc/environment
    set +a
else
    echo "Warning: /etc/environment not found. Running gamescope with defaults."
fi

# --- Universal Driver Detection and Environment Fixes ---

# Initialize extra environment variables string
EXTRA_ENV_VARS=""

# Check if the proprietary NVIDIA kernel module is loaded
if grep -q "nvidia" /proc/modules; then
    # Fix for proprietary NVIDIA driver on Wayland/Gamescope (Missing VK_KHR_wayland_surface)
    echo "Info: Detected NVIDIA proprietary driver. Applying Wayland compatibility fix."
    EXTRA_ENV_VARS+=" __GLX_VENDOR_LIBRARY_NAME=nvidia"
    EXTRA_ENV_VARS+=" WLR_RENDERER=vulkan"
else
    # Default behavior for AMD/Intel (Mesa) drivers.
    echo "Info: Detected non-NVIDIA/Mesa driver. Using default environment."
fi


# --- Build Gamescope Command ---

# Start with the base command
GAMESCOPE_CMD="gamescope"

# Check for the master enable switch. If the first variable is commented out,
# assume the feature is disabled and just run the game directly.
if [[ "$GAMESCOPE_W" == "" ]] && [[ "$(grep -m 1 '^# GAMESCOPE_W=' /etc/environment)" ]]; then
    echo "antisOS Gamemode is disabled. Running command without Gamescope."
    exec "$@"
fi

# Append arguments based on environment variables
# Display/Output
[ -n "$GAMESCOPE_W" ] && GAMESCOPE_CMD+=" -W $GAMESCOPE_W"
[ -n "$GAMESCOPE_H" ] && GAMESCOPE_CMD+=" -H $GAMESCOPE_H"
[ -n "$GAMESCOPE_R" ] && GAMESCOPE_CMD+=" -r $GAMESCOPE_R"

# Internal/Nested Resolution
[ -n "$GAMESCOPE_w" ] && GAMESCOPE_CMD+=" -w $GAMESCOPE_w"
[ -n "$GAMESCOPE_h" ] && GAMESCOPE_CMD+=" -h $GAMESCOPE_h"

# Scaling and Filtering
[ -n "$GAMESCOPE_FILTER" ] && GAMESCOPE_CMD+=" -F $GAMESCOPE_FILTER"
[ -n "$GAMESCOPE_S" ] && [ "$GAMESCOPE_S" != "default" ] && GAMESCOPE_CMD+=" -S $GAMESCOPE_S"
[ -n "$GAMESCOPE_FSR_SHARPNESS" ] && [ "$GAMESCOPE_FSR_SHARPNESS" -gt 0 ] && GAMESCOPE_CMD+=" --fsr-sharpness $GAMESCOPE_FSR_SHARPNESS"

# Toggles (Flags that are either present or not)
[ "$GAMESCOPE_HDR_ENABLED" = "true" ] && GAMESCOPE_CMD+=" --hdr-enabled"
[ "$GAMESCOPE_EXPOSE_WAYLAND" = "true" ] && GAMESCOPE_CMD+=" --expose-wayland"
[ "$GAMESCOPE_STEAM" = "true" ] && GAMESCOPE_CMD+=" --steam"
[ "$GAMESCOPE_ADAPTIVE_SYNC" = "true" ] && GAMESCOPE_CMD+=" --adaptive-sync"
[ "$GAMESCOPE_MANGOAPP" = "true" ] && GAMESCOPE_CMD+=" --mangoapp"
[ "$GAMESCOPE_BORDERLESS" = "true" ] && GAMESCOPE_CMD+=" -b"
[ "$GAMESCOPE_FULLSCREEN" = "true" ] && GAMESCOPE_CMD+=" -f"
[ "$GAMESCOPE_FORCE_FULLSCREEN" = "true" ] && GAMESCOPE_CMD+=" --force-windows-fullscreen"

# Special handling for Steam Deck UI and ES-DE
if [[ "$1" == "steamdeck_ui" ]]; then
 GAMESCOPE_CMD+=" -- steam -steamos3 -gamepadui -steamdeck -steampal"
 shift # Remove "steamdeck-ui" from arguments
elif [[ "$1" == "ES-DE" ]]; then
 GAMESCOPE_CMD+=" -- ES-DE"
 shift # Remove "ES-DE" from arguments
fi

# Arguments with values
[ -n "$GAMESCOPE_SDR_GAMUT_WIDENESS" ] && [ "$(echo "$GAMESCOPE_SDR_GAMUT_WIDENESS > 0" | bc -l)" -eq 1 ] && GAMESCOPE_CMD+=" --sdr-gamut-wideness $GAMESCOPE_SDR_GAMUT_WIDENESS"
[ -n "$GAMESCOPE_BACKEND" ] && [ "$GAMESCOPE_BACKEND" != "auto" ] && GAMESCOPE_CMD+=" --backend $GAMESCOPE_BACKEND"
[ -n "$GAMESCOPE_FRAMERATE_LIMIT" ] && [ "$GAMESCOPE_FRAMERATE_LIMIT" -gt 0 ] && GAMESCOPE_CMD+=" --framerate-limit $GAMESCOPE_FRAMERATE_LIMIT"
[ -n "$GAMESCOPE_HDR_SDR_NITS" ] && [ "$GAMESCOPE_HDR_SDR_NITS" -ne 400 ] && GAMESCOPE_CMD+=" --hdr-sdr-content-nits $GAMESCOPE_HDR_SDR_NITS"

# Note: GAMESCOPE_GEOMETRY is not a standard Gamescope flag and is ignored by this script.

# Add the separator for the command to be executed
GAMESCOPE_CMD+=" --"

# --- Execute the Command ---

echo "-----------------------------------"
echo "antisOS Gamemode: Launching with..."
# Show the environment variables being used
[ -n "$EXTRA_ENV_VARS" ] && echo "Detected/Applied Environment: $EXTRA_ENV_VARS" # This line is correct
echo "Command: $GAMESCOPE_CMD $@"
echo "-----------------------------------"

# EXECUTE: Apply custom environment variables to the final execution
exec env $EXTRA_ENV_VARS $GAMESCOPE_CMD "$@"