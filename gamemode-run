#!/bin/bash
#
# antisOS Gamemode Launcher
#
# This script is a wrapper for running a game or application inside Gamescope
# with settings sourced from /etc/environment.
#
# IMPORTANT: This version integrates critical system checks and optimizations
# from the SteamOS session manager (such as CPU topology tweaks, sentinel checks,
# and disk space management) to ensure reliability and performance.
#
# Usage:
#   gamemode-run.sh [game_executable] [game_arguments...]
#

# --- 1. Session Globals & Environment Setup ---

# Critical performance and system capabilities variables
export WINE_CPU_TOPOLOGY="8:0,1,2,3,4,5,6,7"
export WINEDLLOVERRIDES="dxgi=n"

# Gamescope/MangoHud capabilities advertised to the application/Steam client
export STEAM_MANGOAPP_PRESETS_SUPPORTED=1
export STEAM_USE_MANGOAPP=1
export STEAM_GAMESCOPE_DYNAMIC_FPSLIMITER=1
export STEAM_GAMESCOPE_VRR_SUPPORTED=1
export STEAM_GAMESCOPE_NIS_SUPPORTED=1
export STEAM_GAMESCOPE_FANCY_SCALING_SUPPORT=1
export STEAM_GAMESCOPE_COLOR_MANAGED=1

# Create temporary files required by the environment variables
export MANGOHUD_CONFIGFILE=$(mktemp /tmp/mangohud.XXXXXXXX)
export RADV_FORCE_VRS_CONFIG_FILE=$(mktemp /tmp/radv_vrs.XXXXXXXX)
export GAMESCOPE_LIMITER_FILE=$(mktemp /tmp/gamescope-limiter.XXXXXXXX)

mkdir -p "$(dirname "$MANGOHUD_CONFIGFILE")"
echo "no_display" > "$MANGOHUD_CONFIGFILE" # Initially hide MangoHud
mkdir -p "$(dirname "$RADV_FORCE_VRS_CONFIG_FILE")"
echo "1x1" > "$RADV_FORCE_VRS_CONFIG_FILE" # Initial VRS config

# Ensure the process limit is high enough for games (from SteamOS script)
ulimit -n 524288

# --- 2. Sentinel Checks (System Integrity) ---
# If these files exist, it means a previous session crashed during a reboot/shutdown
# and failed to complete the request. We immediately complete the action.
export STEAMOS_STEAM_REBOOT_SENTINEL="/tmp/steamos-reboot-sentinel"
export STEAMOS_STEAM_SHUTDOWN_SENTINEL="/tmp/steamos-shutdown-sentinel"

if [[ -e "$STEAMOS_STEAM_REBOOT_SENTINEL" ]]; then
	rm -f "$STEAMOS_STEAM_REBOOT_SENTINEL"
	echo "Sentinel detected: Rebooting now." >&2
	sudo -n reboot
	exit 0
fi

if [[ -e "$STEAMOS_STEAM_SHUTDOWN_SENTINEL" ]]; then
	rm -f "$STEAMOS_STEAM_SHUTDOWN_SENTINEL"
	echo "Sentinel detected: Powering off now." >&2
	sudo -n poweroff
	exit 0
fi

# --- 3. Safety Checks ---

if [ "$#" -eq 0 ]; then
    echo "Usage: $0 <command-to-run>"
    echo "Example: $0 supertuxkart"
    exit 1
fi

if ! command -v gamescope &> /dev/null; then
    echo "Warning: 'gamescope' command not found. Running command without Gamescope."
    exec "$@"
fi

# --- 4. Load Configuration ---

if [ -f /etc/environment ]; then
    set -a
    source /etc/environment
    set +a
else
    echo "Warning: /etc/environment not found. Running gamescope with defaults."
fi

# --- 5. Universal Driver Detection and Environment Fixes ---

EXTRA_ENV_VARS=""
if grep -q "nvidia" /proc/modules; then
    echo "Info: Detected NVIDIA proprietary driver. Applying Wayland compatibility fix."
    EXTRA_ENV_VARS+=" __GLX_VENDOR_LIBRARY_NAME=nvidia"
    EXTRA_ENV_VARS+=" WLR_RENDERER=vulkan"
else
    echo "Info: Detected non-NVIDIA/Mesa driver. Using default environment."
fi

# --- 6. Disk Space Maintenance (Critical SteamOS Logic) ---

minimum_free_disk_space_needed_megs=500
free_disk_space_megs=$(df ~/ --output=avail -B1048576 | sed -n '2 p' | xargs)

if [[ "$free_disk_space_megs" -lt "$minimum_free_disk_space_needed_megs" ]]; then
	echo >&2 "gamescope-session: not enough disk space to proceed, trying to find game to delete"

	# This loop finds the oldest game folder and deletes it, along with its ACF and shadercache,
    # until 500MB is freed. This assumes a standard Steam installation path.
	find ~/.local/share/Steam/steamapps/common/ -mindepth 1 -maxdepth 1 -type d -printf "%T@ %p\0" | sort -n -z | while IFS= read -r -d $'\0' line; do
		timestamp=${line%% *}
                game_folder=${line#* }

		[[ -d $game_folder ]]  || continue

		acf=$(grep -F -- "$(basename -- "$game_folder")" ~/.local/share/Steam/steamapps/*.acf | grep \"installdir\" | cut -d: -f1)
		[[ -e "$acf" ]] || continue

		echo >&2 "gamescope-session: deleting $(basename "$game_folder")"
		appid=$(basename "$acf" | cut -d_ -f2 | cut -d. -f1)

		# Remove the game, the ACF file, and the shader cache
		rm -rf --one-file-system -- "$game_folder" "$acf" ~/.local/share/Steam/steamapps/shadercache/"$appid"

		free_disk_space_megs=$(df ~/ --output=avail -B1048576 | sed -n '2 p' | xargs)
		[[ "$free_disk_space_megs" -lt "$minimum_free_disk_space_needed_megs" ]] || break
	done
fi

# --- 7. Build Gamescope Command ---

GAMESCOPE_CMD="gamescope"

# Check for the master enable switch. This logic is a bit crude but preserves the original intent.
if [[ "$GAMESCOPE_W" == "" ]] && [[ "$(grep -m 1 '^# GAMESCOPE_W=' /etc/environment)" ]]; then
    echo "antisOS Gamemode is disabled. Running command without Gamescope."
    exec "$@"
fi

# Append arguments based on environment variables
[ -n "$GAMESCOPE_W" ] && GAMESCOPE_CMD+=" -W $GAMESCOPE_W"
[ -n "$GAMESCOPE_H" ] && GAMESCOPE_CMD+=" -H $GAMESCOPE_H"
[ -n "$GAMESCOPE_R" ] && GAMESCOPE_CMD+=" -r $GAMESCOPE_R"
[ -n "$GAMESCOPE_w" ] && GAMESCOPE_CMD+=" -w $GAMESCOPE_w"
[ -n "$GAMESCOPE_h" ] && GAMESCOPE_CMD+=" -h $GAMESCOPE_h"
[ -n "$GAMESCOPE_FILTER" ] && GAMESCOPE_CMD+=" -F $GAMESCOPE_FILTER"
[ -n "$GAMESCOPE_S" ] && [ "$GAMESCOPE_S" != "default" ] && GAMESCOPE_CMD+=" -S $GAMESCOPE_S"
[ -n "$GAMESCOPE_FSR_SHARPNESS" ] && [ "$GAMESCOPE_FSR_SHARPNESS" -gt 0 ] && GAMESCOPE_CMD+=" --fsr-sharpness $GAMESCOPE_FSR_SHARPNESS"
[ "$GAMESCOPE_HDR_ENABLED" = "true" ] && GAMESCOPE_CMD+=" --hdr-enabled"
[ "$GAMESCOPE_EXPOSE_WAYLAND" = "true" ] && GAMESCOPE_CMD+=" --expose-wayland"
[ "$GAMESCOPE_STEAM" = "true" ] && GAMESCOPE_CMD+=" --steam"
[ "$GAMESCOPE_ADAPTIVE_SYNC" = "true" ] && GAMESCOPE_CMD+=" --adaptive-sync"
[ "$GAMESCOPE_BORDERLESS" = "true" ] && GAMESCOPE_CMD+=" -b"
[ "$GAMESCOPE_FULLSCREEN" = "true" ] && GAMESCOPE_CMD+=" -f"
[ "$GAMESCOPE_FORCE_FULLSCREEN" = "true" ] && GAMESCOPE_CMD+=" --force-windows-fullscreen"
[ -n "$GAMESCOPE_SDR_GAMUT_WIDENESS" ] && [ "$(echo "$GAMESCOPE_SDR_GAMUT_WIDENESS > 0" | bc -l)" -eq 1 ] && GAMESCOPE_CMD+=" --sdr-gamut-wideness $GAMESCOPE_SDR_GAMUT_WIDENESS"
[ -n "$GAMESCOPE_BACKEND" ] && [ "$GAMESCOPE_BACKEND" != "auto" ] && GAMESCOPE_CMD+=" --backend $GAMESCOPE_BACKEND"
[ -n "$GAMESCOPE_FRAMERATE_LIMIT" ] && [ "$GAMESCOPE_FRAMERATE_LIMIT" -gt 0 ] && GAMESCOPE_CMD+=" --framerate-limit $GAMESCOPE_FRAMERATE_LIMIT"
[ -n "$GAMESCOPE_HDR_SDR_NITS" ] && [ "$GAMESCOPE_HDR_SDR_NITS" -ne 400 ] && GAMESCOPE_CMD+=" --hdr-sdr-content-nits $GAMESCOPE_HDR_SDR_NITS"

# Add the separator for the command to be executed
GAMESCOPE_CMD+=" --"

# --- 8. Execution and Teardown ---

# Check if MangoHud wrapping is requested
EXEC_WRAPPER=""
if [ "$MANGOHUD_WRAPPER_ENABLED" = "true" ]; then
    if command -v mangohud &> /dev/null; then
        EXEC_WRAPPER="mangohud"
        echo "Info: MangoHud wrapper enabled."
    else
        echo "Warning: MangoHud requested but 'mangohud' command not found."
    fi
fi

echo "-----------------------------------"
echo "antisOS Gamemode: Launching with..."
[ -n "$EXTRA_ENV_VARS" ] && echo "Detected/Applied Environment: $EXTRA_ENV_VARS"
echo "Final Command: $EXEC_WRAPPER $GAMESCOPE_CMD $@"
echo "-----------------------------------"

# Function to run the command and clean up temporary files
run_command() {
    # We use 'env' to apply the dynamic NVIDIA variables
    env $EXTRA_ENV_VARS $EXEC_WRAPPER $GAMESCOPE_CMD "$@"
}

# Function to handle cleanup on exit
cleanup() {
    echo "Cleaning up temporary files..."
    rm -f "$MANGOHUD_CONFIGFILE" "$RADV_FORCE_VRS_CONFIG_FILE" "$GAMESCOPE_LIMITER_FILE"
}

# Set up a trap to ensure cleanup runs on EXIT or signal (TERM, INT)
trap cleanup EXIT
trap cleanup SIGTERM SIGINT

# Execute the game/app
run_command "$@"